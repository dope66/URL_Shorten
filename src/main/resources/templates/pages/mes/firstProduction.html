<!DOCTYPE html>
<html lang="en"
      layout:fragment="Content"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>초중종물 검사</title>
    <style>

        body {
            background-color: #000;
            color: #FFFFFF;
        }

        input, select {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            background-color: #000;
            color: #00ff00;
            font-weight: bold;
        }

        #workerImage {
            align-content: end;
            object-fit: contain;
            width: 300px;
            height: 300px;
        }

        #keyboardModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #3c3c3c;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 5px;
        }

        .keyboard-button {
            color: #FFFFFF;
            padding: 15px 25px;
            border: 1px solid #5d5d5d;
            border-radius: 4px;
            background-color: #4a4a4a;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .keyboard-button:hover {
            background-color: #e0e0e0;
        }

        .keyboard-ok-button {
            padding: 10px 18px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #info-table-1 {
            width: 100%;
        }

        #info-table-2 {
            width: 100%;

        }
    </style>
</head>
<body>
<table id="info-table-1" th:border="1">
    <thead>
    <th>생산설비</th>
    <th>호기</th>
    <th>검사 1</th>
    <th>검사 2</th>
    </thead>
    <tbody>
    <form id="production-test-form">
        <tr>
            <td>
                <select name="processName" id="processName"  required>
                    <option value="" disabled selected>생산 설비</option>
                </select>
            </td>
            <td>
                <select name="equipmentName" id="equipmentName"  required>
                </select>
            </td>

            <td>
                <input type="text" readonly value="검사 1" id="test1" >
            </td>
            <td>
                <input type="text" readonly value="검사 2" id="test2" >
            </td>

        </tr>

    </form>
    </tbody>
</table>
<table id="info-table-2" th:border="1">
    <thead>
    <th>고객사</th>
    <th>비고</th>
    <th>생산수량</th>
    <th>불량수량</th>
    </thead>
    <tbody>
    <td style="width : 200px"></td>
    <td></td>
    <td style="width : 200px">
        <input type="text" name="productionCount" id="productionCount" style="width: 100%" required
               onclick="openKeyboardForCount('productionCount')">
    </td>
    <td style="width : 200px">
        <input type="text" name="defectCount" id="defectCount" style="width: 100%" required
               onclick="openKeyboardForCount('defectCount')">
    </td>
    </tbody>
</table>
<button style="width: 300px;background-color: #4b4b4b;color:#FFFFFF">등록</button>
<table id="info-table-3" th:border="1">
    <thead>
    <th>공정원</th>
    </thead>
    <tbody>
    <td>
        <div id="image-container">
        <img id="workerImage" alt="workerImage" src="/static/image/defaultWorker.png">
        </div>
        <input readonly type="text" name="processWorker" id="processWorker" style="width : 300px; " required>
    </td>
    </tbody>

</table>



<input type="hidden" id="workerId">
<div id="keyboardModal" class="modal">
    <div class="modal-content">
        <div class="keyboard-row">
            <button class="keyboard-button" onclick="pressKey(1)">1</button>
            <button class="keyboard-button" onclick="pressKey(2)">2</button>
            <button class="keyboard-button" onclick="pressKey(3)">3</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-button" onclick="pressKey(4)">4</button>
            <button class="keyboard-button" onclick="pressKey(5)">5</button>
            <button class="keyboard-button" onclick="pressKey(6)">6</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-button" onclick="pressKey(7)">7</button>
            <button class="keyboard-button" onclick="pressKey(8)">8</button>
            <button class="keyboard-button" onclick="pressKey(9)">9</button>
        </div>
        <div class="keyboard-row">
            <button class="keyboard-button" onclick="pressKey('Cancel')">&times;</button>
            <button class="keyboard-button" onclick="pressKey(0)">0</button>
            <button class="keyboard-ok-button" onclick="pressKey('OK')">OK</button>
        </div>
    </div>
</div>

</body>

<script>


    function fetchProcessNameAndWorkerName() {
        const selectedProcessName = document.getElementById("processName");
        const equipmentNameSelect = document.getElementById("equipmentName");
        const workerNameSelect = document.getElementById("processWorker");

        // equipmentNameSelect 초기화
        equipmentNameSelect.innerHTML = '<option value="" disabled selected>선택하세요</option>';


        // fetch(`/api/worker/getEquipmentName?processName=${encodeURIComponent(selectedProcessName.value)}`)
        fetch(`/api/worker/getEquipmentName?processName=${selectedProcessName.value}`)
            .then(response => response.json())
            .then(equipmentNames => {
                console.log("equipmentName : ", equipmentNames);
                equipmentNames.forEach(equipmentName => {
                    const option = document.createElement('option');
                    option.text = equipmentName;
                    option.value = equipmentName;
                    equipmentNameSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('fetch 오류 요청 ', error);
            });
    }

    const processNameSelect = document.getElementById("processName");
    const equipmentNameSelect = document.getElementById("equipmentName");
    const processWorkerSelect = document.getElementById("processWorker");
    const worekerIdselect = document.getElementById("workerId");
    processNameSelect.addEventListener('change', () => {
        // productionType 변경 시 productionName 값 초기화
        equipmentNameSelect.value = '';
        fetchProcessNameAndWorkerName();
    });
    equipmentNameSelect.addEventListener('change', () => {
        fetch(`/api/worker/getWorkerName?processName=${processNameSelect.value}&equipmentName=${equipmentNameSelect.value}`)
            .then(response => response.json())
            .then(workerInfo => {
                console.log("workerInfo", workerInfo);
                console.log("workerInfo.value", workerInfo.value);
                processWorkerSelect.value = workerInfo;
                fetch(`/api/worker/getWorkerId?processName=${processNameSelect.value}&equipmentName=${equipmentNameSelect.value}&workerName=${processWorkerSelect.value}`)
                    .then(response => response.json())
                    .then(workerId => {
                        console.log("workerId", workerId);
                        worekerIdselect.value = workerId;
                        var imageUrl = "/api/worker/getBase64Image?id=" + workerId;

                        fetch(imageUrl)
                            .then(function (response) {
                                // 이미지가 성공적으로 로드되었는지 확인
                                if (!response.ok) throw new Error('Image not found');
                                return response.text();
                            })
                            .then(function (data) {
                                // 성공적으로 이미지 데이터를 받아온 경우
                                var imageElement = document.querySelector("#workerImage");
                                if (imageElement) {
                                    imageElement.src = data;
                                }
                            })
                            .catch(function (error) {
                                // 이미지 로드에 실패한 경우 기본 이미지로 대체
                                console.error('Error:', error);
                                var imageElement = document.querySelector("#workerImage");
                                if (imageElement) {
                                    imageElement.src = "/static/image/defaultWorker.png"; // 기본 이미지 경로 설정
                                }
                            });
                    }).catch(error => {
                    console.error('아이디를 가져오는 도중 오류 발생: ', error);
                });

            })
            .catch(error => {
                console.error('fetch 오류 요청 ', error);
            });
    });


    // 페이지 로드 시 processNameSelect 요소 초기화
    fetch('/api/worker/getProcessName')
        .then(response => response.json())
        .then(data => {
            console.log("processname: ", data);
            data.forEach(processName => {
                const option = document.createElement('option');
                option.text = processName;
                option.value = processName;
                processNameSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('fetch 오류 요청 ', error);
        });

    // 페이지 로드 시 fetchProcessNameAndWorkerName 함수 호출하여 초기화
    fetchProcessNameAndWorkerName();
</script>
<script>
    const productionTestForm = document.getElementById("production-test-form");
    productionTestForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const processName = document.getElementById('processName').value;
        const equipmentName = document.getElementById("equipmentName").value;
        const processWorker = document.getElementById('processWorker').value;
        const productionCount = document.getElementById('productionCount').value;
        const defectCount = document.getElementById('defectCount').value;
        const newTest = {processName, equipmentName, processWorker, productionCount, defectCount};
        console.log("new Test ;", newTest);
        const confirmed = window.confirm('정말로 등록하시겠습니까?');
        if (confirmed) {
            // 확인을 선택한 경우에만 등록 진행
            fetch('/api/Test/productionTest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newTest)
            })
                .then(response => {
                    if (response.ok) {
                        alert('등록이 완료되었습니다.');
                        window.close();
                    }
                })
                .catch(error => {
                    console.error('fetch 오류 요청 ', error);
                });
        }
    });


</script>
<script>

    function openKeyboardForCount(inputId) {
        // Set a global variable to keep track of the current input field
        currentInputField = document.getElementById(inputId);

        // Open the keyboard modal only if the clicked input field is for productionCount or defectCount
        if (inputId === 'productionCount' || inputId === 'defectCount') {
            openKeyboard();
        }
    }

    // Global variable to keep track of the current input field
    var currentInputField;

    function pressKey(key) {
        if (key === "OK") {
            // 모달을 닫기만 하고 값을 설정하지 않음
            closeKeyboard();
        } else if (key === "Cancel") {
            // Clear input field and close the keyboard modal
            currentInputField.value = "";
            closeKeyboard();
        } else {
            // Add numeric key value to the input field
            currentInputField.value += key;
        }
    }

    function openKeyboard() {
        var modal = document.getElementById("keyboardModal");
        modal.style.display = "block";
    }

    // JavaScript 코드에 closeKeyboard 함수 추가
    function closeKeyboard() {
        var modal = document.getElementById("keyboardModal");
        modal.style.display = "none";
    }


</script>

</html>