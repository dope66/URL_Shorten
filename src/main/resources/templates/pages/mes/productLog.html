<!DOCTYPE html>
<html lang="en"
      layout:fragment="Content"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>생산 일지 목록</title>

    <!-- Handsontable CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">

    <!-- Handsontable JS -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <style>
        #product-log {
            width: 100%;
            height: 100%;
            align-content: center;
        }

    </style>
</head>

<body>
<!-- 검색어를 입력받을 input 필드 추가 -->
<input type="text" id="search-input" placeholder="검색어 입력">
<button onclick="performSearch()">검색</button>

<div id="product-log"></div> <!-- Handsontable 컨테이너 -->

</body>

<div id="pagination">

    <input type="hidden" readonly id="page-number" th:value="1">
    <span id="page-list"></span>
</div>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>



<script src="/dist/libs/apexcharts/dist/apexcharts.min.js"></script>
<!--<script src="/js/mes.js"></script>-->
<script>
    let currentPage = 0;
    let originalData = []; // 원본 데이터 배열
    let hot;
    document.addEventListener("DOMContentLoaded", function () {
        // 페이지 로드 시 실행되는 코드
        fetchProductLog(currentPage); // 초기 페이지 데이터 로딩
    });

    function fetchProductLog(page) {
        fetch(`/api/mes?page=${page}`)
            .then(response => response.json())
            .then(data => {
                originalData = data._embedded.productLogList; // 원본 데이터 업데이트
                createHandsontable(originalData); // Handsontable 인스턴스 생성 및 데이터 적용
                console.log("originalDataPagination", originalData);
                updatePagination(); // 페이지네이션 업데이트
            });
    }
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("ko-KR");
    }
    function createHandsontable(data) {
        const container = document.getElementById('product-log');
        hot  =new Handsontable(container, {
            licenseKey: 'non-commercial-and-evaluation',
            data: data.map(productLog => [
                productLog.productionType,
                formatDate(productLog.workDate),
                productLog.productionNumber,
                productLog.productionName,
                productLog.production,
                productLog.workerName

            ]),
            colHeaders: [ '차종', '작업 일', '품번', '품명', '생산량', '생산자'],
            columns: [
                {data: 0, readOnly: true},
                {data: 1, readOnly: true},
                {data: 2, readOnly: true},
                {data: 3, readOnly: true},
                {data: 4, readOnly: true},
                {data: 5, readOnly: true}
            ],
            columnSorting: true, // 정렬 활성화
            contextMenu: false, // 우클릭 메뉴 활성화
            manualRowMove: true, // 행 이동 활성화
            manualColumnMove: true, // 열 이동 활성화
            filters: true, // 필터링 활성화
            dropdownMenu: false, // 드롭다운 메뉴 활성화
            rowHeaders: true, // 행 번호 표시
            search: true, // 검색 기능 활성화
            // 기타 필요한 Handsontable 옵션 추가
        });

        console.log("hot : ", hot);
    }
    function performSearch() {
        if (!hot || !hot.getPlugin('search')) {
            console.error('Handsontable 인스턴스가 초기화되지 않았거나, 검색 플러그인을 사용할 수 없습니다.');
            return;
        }

        const query = document.getElementById('search-input').value.trim();

        // 검색창이 비어 있는 경우 원본 데이터 로드
        if (query === '') {
            console.log("이건 진짜 안넣은거");
            hot.loadData(originalData.map(item => [
                item.productionType,
                formatDate(item.workDate),
                item.productionNumber,
                item.productionName,
                item.production,
                item.workerName
            ]));
            console.log('전체 데이터를 표시합니다.');
            return;
        }

        // 검색 플러그인을 사용하여 원본 데이터에서 검색 수행
        const searchPlugin = hot.getPlugin('search');
        // Handsontable의 데이터를 원본 데이터로 임시 설정
        hot.loadData(originalData.map(item => [
            item.productionType,
            formatDate(item.workDate),
            item.productionNumber,
            item.productionName,
            item.production,
            item.workerName
        ]));
        const searchResult = searchPlugin.query(query);

        // 검색 결과에 일치하는 행 인덱스만 추출하고 중복 제거
        let resultRowsIndexes = Array.from(new Set(searchResult.map(result => result.row)));

        // 검색된 행 인덱스를 사용하여 원본 데이터에서 해당 행의 데이터를 추출
        const filteredData = resultRowsIndexes.map(index => originalData[index]).map(item => [
            item.productionType,
            formatDate(item.workDate),
            item.productionNumber,
            item.productionName,
            item.production,
            item.workerName
        ]);

        // 검색 결과가 있으면 해당 데이터 로드, 없으면 원본 데이터 로드
        if (filteredData.length > 0) {
            hot.loadData(filteredData);
            console.log('검색된 데이터를 표시합니다.');
        } else {
            console.log('검색 결과가 없습니다. 전체 데이터를 표시합니다.');
            hot.loadData(originalData.map(item => [
                item.productionType,
                formatDate(item.workDate),
                item.productionNumber,
                item.productionName,
                item.production,
                item.workerName
            ]));
        }
    }


</script>

</html>