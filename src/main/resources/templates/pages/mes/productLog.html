<!DOCTYPE html>
<html lang="en"
      layout:fragment="Content"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>생산 일지 목록</title>

    <!-- Handsontable CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">

    <!-- Handsontable JS -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <style>
        #product-log {
            width: 100%;
            height: 100%;
            align-content: center;
        }

    </style>
</head>

<body>
<!-- 검색어를 입력받을 input 필드 추가 -->
<!-- 검색어를 입력받을 input 필드 추가 -->

<!-- 날짜 범위를 입력받을 input 필드 추가 -->
<input type="date" id="start-date" placeholder="시작일">
<input type="date" id="end-date" placeholder="종료일">
<input type="text" id="search-input" placeholder="검색어 입력">
<button onclick="performSearch()">검색</button>




<div id="product-log"></div> <!-- Handsontable 컨테이너 -->

</body>

<div id="pagination">

    <input type="hidden" readonly id="page-number" th:value="1">
    <span id="page-list"></span>
</div>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>



<script src="/dist/libs/apexcharts/dist/apexcharts.min.js"></script>
<!--<script src="/js/mes.js"></script>-->
<script>
    let currentPage = 0;
    let originalData = []; // 원본 데이터 배열
    let hot;
    document.addEventListener("DOMContentLoaded", function () {
        // 페이지 로드 시 실행되는 코드
        fetchProductLog(currentPage); // 초기 페이지 데이터 로딩
    });

    function fetchProductLog(page) {
        fetch(`/api/mes?page=${page}`)
            .then(response => response.json())
            .then(data => {
                originalData = data._embedded.productLogList; // 원본 데이터 업데이트
                createHandsontable(originalData); // Handsontable 인스턴스 생성 및 데이터 적용
                console.log("originalDataPagination", originalData);
                updatePagination(); // 페이지네이션 업데이트
            });
    }
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("ko-KR");
    }
    function createHandsontable(data) {
        const container = document.getElementById('product-log');
        hot  =new Handsontable(container, {
            licenseKey: 'non-commercial-and-evaluation',
            data: data.map(productLog => [
                productLog.productionType,
                formatDate(productLog.workDate),
                productLog.productionNumber,
                productLog.productionName,
                productLog.production,
                productLog.workerName

            ]),
            colHeaders: [ '차종', '작업 일', '품번', '품명', '생산량', '생산자'],
            columns: [
                {data: 0, readOnly: true},
                {data: 1, readOnly: true},
                {data: 2, readOnly: true},
                {data: 3, readOnly: true},
                {data: 4, readOnly: true},
                {data: 5, readOnly: true}
            ],
            columnSorting: true, // 정렬 활성화
            contextMenu: false, // 우클릭 메뉴 활성화
            manualRowMove: true, // 행 이동 활성화
            manualColumnMove: true, // 열 이동 활성화
            filters: true, // 필터링 활성화
            dropdownMenu: false, // 드롭다운 메뉴 활성화
            rowHeaders: true, // 행 번호 표시
            search: true, // 검색 기능 활성화
            // 기타 필요한 Handsontable 옵션 추가
        });

        console.log("hot : ", hot);
    }


    function performSearch() {
        if (!hot || !hot.getPlugin('search')) {
            console.error('Handsontable 인스턴스가 초기화되지 않았거나, 검색 플러그인을 사용할 수 없습니다.');
            return;
        }

        const query = document.getElementById('search-input').value.trim();
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        // 원본 데이터에서 날짜 조건에 맞는 데이터를 필터링
        let dateFilteredData = originalData.filter(item => {
            const itemDate = new Date(item.workDate);
            // 시작 날짜 조건
            const startCondition = startDate ? new Date(startDate) <= itemDate : true;

            // 종료 날짜 조건 - 당일 포함 (endDate의 23:59:59까지 포함)
            let endCondition = true;
            if (endDate) {
                let endDateObj = new Date(endDate);
                endDateObj.setHours(23, 59, 59); // 종료 날짜를 당일의 마지막 시각으로 설정
                endCondition = itemDate <= endDateObj;
            }

            return startCondition && endCondition;
        });

        let filteredData = [];
        if (query) {
            // 임시로 날짜 필터링된 데이터를 Handsontable에 로드하여 검색 수행
            hot.loadData(dateFilteredData.map(item => [
                item.productionType,
                formatDate(item.workDate),
                item.productionNumber,
                item.productionName,
                item.production,
                item.workerName
            ]));

            // 검색 플러그인으로 검색 수행
            const searchPlugin = hot.getPlugin('search');
            const searchResult = searchPlugin.query(query);
            let resultRowsIndexes = Array.from(new Set(searchResult.map(result => result.row)));
            filteredData = resultRowsIndexes.map(index => dateFilteredData[index]);
        } else {
            // 검색어가 없는 경우, 날짜 필터링 결과를 그대로 사용
            filteredData = dateFilteredData;
        }

        // 필터링된 데이터 로드
        if (filteredData.length > 0) {
            hot.loadData(filteredData.map(item => [
                item.productionType,
                formatDate(item.workDate),
                item.productionNumber,
                item.productionName,
                item.production,
                item.workerName
            ]));
            console.log('검색 및 날짜 필터링된 데이터를 표시합니다.');
        } else {
            console.log('조건에 맞는 데이터가 없습니다.');
            hot.loadData([]);
        }
    }



</script>

</html>